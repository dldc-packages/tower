/**
 * Docker Compose file generator
 *
 * Generate complete docker-compose.yml with infrastructure and app services.
 */

import type { Intent } from "@dldc/tower/types";
import { logger } from "../utils/logger.ts";

/**
 * Generate docker-compose.yml content
 */
export function generateCompose(intent: Intent, resolvedImages: Map<string, string>): string {
  logger.info("Generating docker-compose.yml...");

  const services = {
    ...generateInfraServices(intent),
    ...generateAppServices(intent, resolvedImages),
  };

  const compose = {
    version: "3.8",
    services,
    networks: {
      app_network: {
        driver: "bridge",
      },
    },
    volumes: {
      caddy_data: {},
      caddy_config: {},
      otel_lgtm_data: {},
      registry_data: {},
    },
  };

  return `# Generated by Tower - Do not edit manually\n${toYaml(compose)}`;
}

/**
 * Generate infrastructure services (Caddy, Tower, Registry, OTEL)
 */
function generateInfraServices(intent: Intent): Record<string, unknown> {
  return {
    caddy: {
      image: "caddy:2",
      ports: ["80:80", "443:443"],
      volumes: [
        "/var/infra/Caddyfile:/etc/caddy/Caddyfile:ro",
        "caddy_data:/data",
        "caddy_config:/config",
      ],
      networks: ["app_network"],
      restart: "unless-stopped",
    },

    tower: {
      image: `ghcr.io/dldc-packages/tower:${intent.tower.version}`,
      environment: [
        "TOWER_DATA_DIR=/var/infra",
        "OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-lgtm:4318/v1/traces",
      ],
      volumes: [
        "/var/infra:/var/infra",
        "/var/run/docker.sock:/var/run/docker.sock",
      ],
      networks: ["app_network"],
      restart: "unless-stopped",
      healthcheck: {
        test: ["CMD", "curl", "-f", "http://localhost:3100/status"],
        interval: "10s",
        timeout: "5s",
        retries: 3,
      },
    },

    registry: {
      image: "registry:2",
      environment: [
        "REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY=/var/lib/registry",
        "REGISTRY_STORAGE_DELETE_ENABLED=true",
      ],
      volumes: ["registry_data:/var/lib/registry"],
      networks: ["app_network"],
      restart: "unless-stopped",
      healthcheck: {
        test: ["CMD", "wget", "--spider", "-q", "http://localhost:5000/v2/"],
        interval: "10s",
      },
    },

    "otel-lgtm": {
      image: `grafana/otel-lgtm:${intent.otel.version}`,
      volumes: ["otel_lgtm_data:/data"],
      networks: ["app_network"],
      restart: "unless-stopped",
    },
  };
}

/**
 * Generate app services from intent
 */
function generateAppServices(
  intent: Intent,
  resolvedImages: Map<string, string>,
): Record<string, unknown> {
  const services: Record<string, unknown> = {};

  for (const app of intent.apps) {
    const image = resolvedImages.get(app.name) ?? app.image;

    const environment = {
      ...app.env,
      ...app.secrets,
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-lgtm:4318/v1/traces",
    };

    services[app.name] = {
      image,
      environment: Object.entries(environment).map(([k, v]) => `${k}=${v}`),
      networks: ["app_network"],
      restart: "unless-stopped",
      ...(app.healthCheck && {
        healthcheck: {
          test: app.healthCheck.path
            ? ["CMD", "curl", "-f", `http://localhost:${app.port ?? 3000}${app.healthCheck.path}`]
            : ["CMD", "true"],
          interval: `${app.healthCheck.interval ?? 10}s`,
          timeout: `${app.healthCheck.timeout ?? 5}s`,
          retries: app.healthCheck.retries ?? 3,
        },
      }),
    };
  }

  return services;
}

/**
 * Simple YAML serialization (minimal implementation)
 */
function toYaml(obj: unknown, indent: number = 0): string {
  const spaces = "  ".repeat(indent);

  if (Array.isArray(obj)) {
    return obj.map((item) => `${spaces}- ${toYaml(item, indent + 1).trim()}`).join("\n");
  }

  if (typeof obj === "object" && obj !== null) {
    return Object.entries(obj)
      .map(([key, value]) => {
        if (Array.isArray(value) || typeof value === "object") {
          return `${spaces}${key}:\n${toYaml(value, indent + 1)}`;
        }
        return `${spaces}${key}: ${JSON.stringify(value)}`;
      })
      .join("\n");
  }

  return String(obj);
}
